# =====================================================
# FABRIC DE BOLSILLO - FASE 1: MinIO
# =====================================================

.PHONY: help up down restart logs test health create-bucket clean backup restore

# Variables
TIMESTAMP := $(shell date +"%Y%m%d_%H%M%S")
BACKUP_DIR := ../../backups/fase1

# Default target
help:
	@echo ""
	@echo "üóÑÔ∏è  FASE 1: MinIO (Data Lake)"
	@echo "============================"
	@echo ""
	@echo "üìö GESTI√ìN B√ÅSICA:"
	@echo "  up          - Levantar MinIO"
	@echo "  down        - Parar MinIO"
	@echo "  restart     - Reiniciar MinIO"
	@echo "  logs        - Ver logs en tiempo real"
	@echo ""
	@echo "üß™ VALIDACIONES:"
	@echo "  test        - Test completo automatizado"
	@echo "  health      - Solo health check"
	@echo "  create-bucket - Crear bucket por defecto"
	@echo ""
	@echo "üõ†Ô∏è UTILIDADES:"
	@echo "  clean       - Limpiar datos (¬°cuidado!)"
	@echo "  backup      - Backup de datos"
	@echo "  restore     - Restaurar √∫ltimo backup"
	@echo ""
	@echo "üí° INICIO R√ÅPIDO:"
	@echo "  1. cp .env.example .env"
	@echo "  2. make up"
	@echo "  3. make test"
	@echo "  4. Abrir http://localhost:9001"
	@echo ""

# =====================================================
# GESTI√ìN B√ÅSICA
# =====================================================

up:
	@echo "üöÄ Levantando MinIO..."
	@if [ ! -f .env ]; then echo "‚ùå Archivo .env no encontrado. Ejecuta: cp .env.example .env"; exit 1; fi
	docker compose up -d
	@echo "‚úÖ MinIO iniciado"
	@echo "üåê Consola web: http://localhost:$$(grep MINIO_CONSOLE_PORT .env | cut -d'=' -f2)"
	@echo "üîë Usuario: $$(grep MINIO_ROOT_USER .env | cut -d'=' -f2)"

down:
	@echo "üõë Parando MinIO..."
	docker compose down
	@echo "‚úÖ MinIO parado"

restart:
	@echo "üîÑ Reiniciando MinIO..."
	docker compose down
	docker compose up -d
	@echo "‚úÖ MinIO reiniciado"

logs:
	@echo "üìã Logs de MinIO (Ctrl+C para salir):"
	docker compose logs -f

# =====================================================
# VALIDACIONES
# =====================================================

test:
	@echo "üß™ Ejecutando test completo de MinIO..."
	@chmod +x test.sh
	@./test.sh

health:
	@echo "üè• Verificando health de MinIO..."
	@if docker ps | grep -q fabric-minio; then \
		echo "‚úÖ Contenedor corriendo"; \
		curl -f http://localhost:$$(grep MINIO_API_PORT .env | cut -d'=' -f2)/minio/health/live >/dev/null 2>&1 && \
		echo "‚úÖ API respondiendo" || echo "‚ùå API no responde"; \
	else \
		echo "‚ùå Contenedor no est√° corriendo"; \
	fi

create-bucket:
	@echo "üì¶ Creando bucket por defecto..."
	@docker exec fabric-minio mc mb /data/$$(grep MINIO_DEFAULT_BUCKET .env | cut -d'=' -f2) 2>/dev/null || true
	@echo "‚úÖ Bucket creado o ya exist√≠a"

# =====================================================
# UTILIDADES
# =====================================================

clean:
	@echo "üö® ¬°CUIDADO! Esto eliminar√° todos los datos de MinIO"
	@read -p "¬øEst√°s seguro? Escribe 'SI' en may√∫sculas: " confirm; \
	if [ "$$confirm" = "SI" ]; then \
		echo "üßπ Limpiando..."; \
		docker compose down; \
		rm -rf ../../data/minio/*; \
		echo "‚úÖ Datos eliminados"; \
	else \
		echo "‚ùå Operaci√≥n cancelada"; \
	fi

backup:
	@echo "üíæ Creando backup de MinIO..."
	@mkdir -p $(BACKUP_DIR)
	@tar -czf $(BACKUP_DIR)/minio_$(TIMESTAMP).tar.gz -C ../../data/minio .
	@echo "‚úÖ Backup guardado en $(BACKUP_DIR)/minio_$(TIMESTAMP).tar.gz"

restore:
	@echo "üìÇ Listando backups disponibles:"
	@ls -la $(BACKUP_DIR)/*.tar.gz 2>/dev/null || echo "No hay backups disponibles"
	@read -p "Nombre del archivo a restaurar: " backup_file; \
	if [ -f "$(BACKUP_DIR)/$$backup_file" ]; then \
		echo "üîÑ Restaurando $$backup_file..."; \
		docker compose down; \
		rm -rf ../../data/minio/*; \
		tar -xzf $(BACKUP_DIR)/$$backup_file -C ../../data/minio; \
		echo "‚úÖ Backup restaurado"; \
	else \
		echo "‚ùå Archivo no encontrado"; \
	fi

# =====================================================
# DESARROLLO Y DEBUG
# =====================================================

shell:
	@echo "üñ•Ô∏è Accediendo al shell de MinIO..."
	docker exec -it fabric-minio sh

mc:
	@echo "üîß Ejecutando MinIO Client..."
	docker exec -it fabric-minio mc --help