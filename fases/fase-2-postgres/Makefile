# =====================================================
# FABRIC DE BOLSILLO - FASE 2: MinIO + PostgreSQL
# =====================================================

.PHONY: help up down restart logs test test-connection test-schemas psql clean backup restore

# Variables
TIMESTAMP := $(shell date +"%Y%m%d_%H%M%S")
BACKUP_DIR := ../../backups/fase2

# Default target
help:
	@echo ""
	@echo "ğŸ—ƒï¸  FASE 2: MinIO + PostgreSQL"
	@echo "================================"
	@echo ""
	@echo "ğŸ“š GESTIÃ“N BÃSICA:"
	@echo "  up          - Levantar MinIO + PostgreSQL"
	@echo "  down        - Parar servicios"
	@echo "  restart     - Reiniciar servicios"
	@echo "  logs        - Ver logs en tiempo real"
	@echo ""
	@echo "ğŸ§ª VALIDACIONES:"
	@echo "  test        - Test completo automatizado"
	@echo "  test-connection - Solo conectividad"
	@echo "  test-schemas    - Solo esquemas"
	@echo ""
	@echo "ğŸ—ƒï¸ BASE DE DATOS:"
	@echo "  psql        - Conectar a PostgreSQL"
	@echo "  create-tables   - Crear tablas del modelo"
	@echo "  drop-tables     - Eliminar tablas (Â¡cuidado!)"
	@echo ""
	@echo "ğŸ› ï¸ UTILIDADES:"
	@echo "  clean       - Limpiar datos (Â¡cuidado!)"
	@echo "  backup      - Backup de PostgreSQL"
	@echo "  restore     - Restaurar backup"
	@echo ""
	@echo "ğŸ’¡ INICIO RÃPIDO:"
	@echo "  1. cp .env.example .env"
	@echo "  2. make up"
	@echo "  3. make test"
	@echo "  4. make psql"
	@echo ""

# =====================================================
# GESTIÃ“N BÃSICA
# =====================================================

up:
	@echo "ğŸš€ Levantando MinIO + PostgreSQL..."
	@if [ ! -f .env ]; then echo "âŒ Archivo .env no encontrado. Ejecuta: cp .env.example .env"; exit 1; fi
	docker compose up -d
	@echo "â³ Esperando a que los servicios estÃ©n listos..."
	@sleep 10
	@echo "âœ… Servicios iniciados"
	@echo "ğŸŒ MinIO Console: http://localhost:$$(grep MINIO_CONSOLE_PORT .env | cut -d'=' -f2)"
	@echo "ğŸ—ƒï¸ PostgreSQL: localhost:$$(grep POSTGRES_PORT .env | cut -d'=' -f2)"
	@echo ""
	@echo "ğŸ”‘ Credenciales:"
	@echo "   MinIO: $$(grep MINIO_ROOT_USER .env | cut -d'=' -f2) / $$(grep MINIO_ROOT_PASSWORD .env | cut -d'=' -f2)"
	@echo "   PostgreSQL: $$(grep POSTGRES_USER .env | cut -d'=' -f2) / $$(grep POSTGRES_PASSWORD .env | cut -d'=' -f2)"

down:
	@echo "ğŸ›‘ Parando servicios..."
	docker compose down
	@echo "âœ… Servicios parados"

restart:
	@echo "ğŸ”„ Reiniciando servicios..."
	docker compose down
	docker compose up -d
	@sleep 10
	@echo "âœ… Servicios reiniciados"

logs:
	@echo "ğŸ“‹ Logs de servicios (Ctrl+C para salir):"
	docker compose logs -f

# =====================================================
# VALIDACIONES
# =====================================================

test:
	@echo "ğŸ§ª Ejecutando test completo..."
	@chmod +x test.sh
	@./test.sh

test-connection:
	@echo "ğŸ”— Verificando conectividad..."
	@echo "  MinIO..."
	@if docker ps | grep -q fabric-minio; then \
		echo "  âœ… MinIO container running"; \
		curl -f http://localhost:$$(grep MINIO_API_PORT .env | cut -d'=' -f2)/minio/health/live >/dev/null 2>&1 && \
		echo "  âœ… MinIO API responding" || echo "  âŒ MinIO API not responding"; \
	else \
		echo "  âŒ MinIO container not running"; \
	fi
	@echo "  PostgreSQL..."
	@if docker ps | grep -q fabric-postgres; then \
		echo "  âœ… PostgreSQL container running"; \
		docker exec fabric-postgres pg_isready -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) >/dev/null 2>&1 && \
		echo "  âœ… PostgreSQL responding" || echo "  âŒ PostgreSQL not responding"; \
	else \
		echo "  âŒ PostgreSQL container not running"; \
	fi

test-schemas:
	@echo "ğŸ“Š Verificando esquemas..."
	@docker exec fabric-postgres psql -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) -c "\dn" 2>/dev/null | grep -E "(dw|staging)" && echo "âœ… Esquemas creados" || echo "âŒ Esquemas no encontrados"

# =====================================================
# BASE DE DATOS
# =====================================================

psql:
	@echo "ğŸ—ƒï¸ Conectando a PostgreSQL..."
	@echo "Comandos Ãºtiles:"
	@echo "  \dn          - Listar esquemas"
	@echo "  \dt dw.*     - Listar tablas del esquema dw"
	@echo "  \q           - Salir"
	@echo ""
	docker exec -it fabric-postgres psql -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2)

create-tables:
	@echo "ğŸ“Š Creando tablas del modelo..."
	@echo "(Pendiente - Paso 3 del proceso)"

drop-tables:
	@echo "ğŸš¨ Â¡CUIDADO! Esto eliminarÃ¡ todas las tablas"
	@read -p "Â¿EstÃ¡s seguro? Escribe 'SI' en mayÃºsculas: " confirm; \
	if [ "$$confirm" = "SI" ]; then \
		echo "ğŸ—‘ï¸ Eliminando tablas..."; \
		docker exec fabric-postgres psql -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) -c "DROP SCHEMA IF EXISTS dw CASCADE; DROP SCHEMA IF EXISTS staging CASCADE;"; \
		echo "âœ… Tablas eliminadas"; \
	else \
		echo "âŒ OperaciÃ³n cancelada"; \
	fi

# =====================================================
# UTILIDADES
# =====================================================

clean:
	@echo "ğŸš¨ Â¡CUIDADO! Esto eliminarÃ¡ todos los datos"
	@read -p "Â¿EstÃ¡s seguro? Escribe 'SI' en mayÃºsculas: " confirm; \
	if [ "$$confirm" = "SI" ]; then \
		echo "ğŸ§¹ Limpiando..."; \
		docker compose down; \
		rm -rf ../../data/minio/* ../../data/postgres/*; \
		echo "âœ… Datos eliminados"; \
	else \
		echo "âŒ OperaciÃ³n cancelada"; \
	fi

backup:
	@echo "ğŸ’¾ Creando backup de PostgreSQL..."
	@mkdir -p $(BACKUP_DIR)
	@docker exec fabric-postgres pg_dump -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2) | gzip > $(BACKUP_DIR)/postgres_$(TIMESTAMP).sql.gz
	@echo "âœ… Backup guardado en $(BACKUP_DIR)/postgres_$(TIMESTAMP).sql.gz"

restore:
	@echo "ğŸ“‚ Listando backups disponibles:"
	@ls -la $(BACKUP_DIR)/*.sql.gz 2>/dev/null || echo "No hay backups disponibles"
	@read -p "Nombre del archivo a restaurar: " backup_file; \
	if [ -f "$(BACKUP_DIR)/$$backup_file" ]; then \
		echo "ğŸ”„ Restaurando $$backup_file..."; \
		zcat $(BACKUP_DIR)/$$backup_file | docker exec -i fabric-postgres psql -U $$(grep POSTGRES_USER .env | cut -d'=' -f2) -d $$(grep POSTGRES_DB .env | cut -d'=' -f2); \
		echo "âœ… Backup restaurado"; \
	else \
		echo "âŒ Archivo no encontrado"; \
	fi

# =====================================================
# DESARROLLO Y DEBUG
# =====================================================

network:
	@echo "ğŸŒ InformaciÃ³n de red Docker:"
	@docker network inspect fabric_net | grep -E '"Name"|"IPv4Address"' || echo "Red no encontrada"

status:
	@echo "ğŸ“Š Estado de contenedores:"
	@docker ps --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}" | grep fabric